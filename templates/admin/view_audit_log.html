{% extends "base.html" %}

{% block title %}Log de Auditoria{% endblock %}

{% block content %}
<h2 class="page-title"><i class="fas fa-history"></i> Log de Auditoria do Sistema</h2>

<div class="card filter-form mb-4">
    <div class="card-header">
        <h3><i class="fas fa-filter"></i> Filtrar Logs</h3>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('view_audit_log') }}" class="form-inline">
            <div class="form-group">
                <label for="filter_action">Ação:</label>
                <input type="text" name="filter_action" id="filter_action" value="{{ filters.action or '' }}" class="form-control form-control-sm">
            </div>
            <div class="form-group">
                <label for="filter_username">Usuário:</label>
                <input type="text" name="filter_username" id="filter_username" value="{{ filters.username or '' }}" class="form-control form-control-sm">
            </div>
            <div class="form-group">
                <label for="filter_date_from">Data De:</label>
                <input type="date" name="filter_date_from" id="filter_date_from" value="{{ filters.date_from or '' }}" class="form-control form-control-sm">
            </div>
            <div class="form-group">
                <label for="filter_date_to">Data Até:</label>
                <input type="date" name="filter_date_to" id="filter_date_to" value="{{ filters.date_to or '' }}" class="form-control form-control-sm">
            </div>
            <div class="form-group-actions">
                <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search"></i> Filtrar</button>
                <a href="{{ url_for('view_audit_log') }}" class="btn btn-secondary btn-sm"><i class="fas fa-times-circle"></i> Limpar</a>
            </div>
        </form>
    </div>
</div>

{% if logs %}
    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm"> {# Adicionado table-sm para mais compactação #}
            <thead>
                <tr>
                    <th style="width: 15%;">Timestamp (Local)</th>
                    <th style="width: 15%;">Usuário</th>
                    <th style="width: 20%;">Ação</th>
                    <th style="width: 40%;">Detalhes</th>
                    <th style="width: 10%;">Endereço IP</th>
                </tr>
            </thead>
            <tbody>
                {% for log_entry in logs %}
                <tr>
                    <td style="white-space: nowrap;">{{ log_entry.timestamp_fmt }}</td>
                    <td>{{ log_entry.username or 'N/A' }}{% if log_entry.user_id %} (ID: {{ log_entry.user_id }}){% endif %}</td>
                    <td>{{ log_entry.action }}</td>
                    <td><small>{{ log_entry.details or '' }}</small></td>
                    <td>{{ log_entry.ip_address }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if total_pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('view_audit_log', page=current_page-1, filter_action=filters.action, filter_username=filters.username, filter_date_from=filters.date_from, filter_date_to=filters.date_to) }}">Anterior</a>
            </li>
            {% set page_window = 2 %} {# Quantas páginas mostrar antes e depois da atual #}
            {% for p in range(1, total_pages + 1) %}
                {% if p == 1 or p == total_pages or (p >= current_page - page_window and p <= current_page + page_window) %}
                    {% if p == current_page %}
                        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('view_audit_log', page=p, filter_action=filters.action, filter_username=filters.username, filter_date_from=filters.date_from, filter_date_to=filters.date_to) }}">{{ p }}</a></li>
                    {% endif %}
                {% elif p == current_page - page_window - 1 or p == current_page + page_window + 1 %}
                     <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('view_audit_log', page=current_page+1, filter_action=filters.action, filter_username=filters.username, filter_date_from=filters.date_from, filter_date_to=filters.date_to) }}">Próxima</a>
            </li>
        </ul>
    </nav>
    {% endif %}

{% else %}
    <div class="card no-data-message">
        <div class="card-body">
            <i class="fas fa-folder-open"></i>
            Nenhum registro de auditoria encontrado com os filtros aplicados ou não há logs registrados.
        </div>
    </div>
{% endif %}
{% endblock %}

{% block head_extra %}
{{ super() }} {# Para herdar estilos de base.html se houver #}
<style>
    .form-control-sm { /* Estilos já devem existir em style.css, mas pode reforçar aqui se necessário */
        font-size: 0.875rem;
    }
    .btn-sm {
        font-size: 0.875rem;
    }
    .page-link {
        color: var(--link-color);
    }
    .page-item.active .page-link {
        background-color: var(--link-color);
        border-color: var(--link-color);
        color: white;
    }
    .page-item.disabled .page-link {
        color: var(--text-muted-color);
    }
    .table-sm td, .table-sm th {
        padding: .4rem .5rem; /* Mais compacto */
    }
</style>
{% endblock %}